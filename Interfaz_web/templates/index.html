<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>Monitoreo</title>
        <link rel="icon" type="image/x-icon" href="static/assets/img/favico1.png" />
        <!-- Font Awesome icons (free version)-->
        <script src="https://use.fontawesome.com/releases/v5.15.1/js/all.js" crossorigin="anonymous"></script>
        <!-- Google fonts-->
        <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css" />
        <link href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic,700italic" rel="stylesheet" type="text/css" />
        <link href="https://fonts.googleapis.com/css?family=Roboto+Slab:400,100,300,700" rel="stylesheet" type="text/css" />
        <!-- Core theme CSS (includes Bootstrap)-->
        <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/styles.css') }}">
        <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/lightbox.css') }}">
        <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/dataTables.bootstrap4.css') }}">
        <link rel="stylesheet" href="static/css/leaflet.css"
            integrity=""
            crossorigin=""/>
        <link rel="preconnect" href="https://fonts.gstatic.com">
        <link href="https://fonts.googleapis.com/css2?family=Anton&display=swap" rel="stylesheet">
        
        <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/jquery.jgrowl.css') }}">
        
        
    </head>
    <body id="page-top">
        <!-- NAVEGACIÓN-->
        <nav class="navbar navbar-expand-sm navbar-light fixed-top" id="mainNav">
            <div class="container-fluid" style="padding-right:0rem; margin-right:1rem;">
              <div class="collapse navbar-collapse">
                  <ul class="navbar-nav text-uppercase mr-auto">
                      <li class="nav-item">
                        <a class="nav-link js-scroll-trigger" href="#inicio"><img style="vertical-align: middle; margin-right:8px; margin-bottom:2px; margin-top:2px;" src="static/assets/img/favico2.png" width="64" height="55"></a>
                      </li>
                  </ul>
              </div>
              <div class="collapse navbar-collapse">
                  <ul class="navbar-nav text-uppercase ml-auto">
                      <li class="nav-item">
                        <a class="nav-link js-scroll-trigger" href="#en_vivo"><img style="vertical-align: middle; margin-right:8px; margin-bottom:5px;" src="static/assets/img/camara3.png" width="40" height="35">En vivo</a>
                      </li>
                      <li class="nav-item">
                        <a class="nav-link js-scroll-trigger" href="#ubicacion"><img style="vertical-align: middle; margin-right:8px; margin-bottom:8px;" src="static/assets/img/ubicacion.png" width="35" height="32">Ubicación</a>
                      </li>
                      <li class="nav-item">
                        <a class="nav-link js-scroll-trigger" href="#historial"><img style="vertical-align: middle; margin-right:8px; margin-bottom:5px;" src="static/assets/img/libro.png" width="38" height="38">Historial</a>
                      </li>
                  </ul>
              </div>
            </div>
        </nav>
        <!-- Masthead-->
        <header class="masthead" id="inicio">
            <div class="container">
                <div class="masthead-heading text-uppercase">Monitoreo de incendios forestales</div>
            </div>
        </header>
        <!-- CáMARAS EN VIVO-->
        <section class="page-section" id="en_vivo">
            <div class="container">
                <div class="text-center">
                    <h2 class="section-heading text-uppercase" style="margin-bottom:5px;" ><img src="static/assets/img/En_vivo.png" width="300" height="80"></h2>
                </div>
                <div class="row text-center" style="margin-left:-1.25rem;">
                    <div class="col-xl-6">
                        <img src="{{ url_for('video_feed2') }}" width="560" height="420" style="border: 5px solid; color: white;">
                    </div>
                    <div class="col-xl-6">
                        <img src="{{ url_for('video_feed1') }}" width="560" height="420" style="border: 5px solid; color: white;">
                    </div>
                    <img src="static/assets/img/colorbar_edit4.png" width="130" height="420" style="position:absolute; left : 20px;">
                </div>
            </div>
        </section>
        <!-- UBICACIÓN-->
        <section class="page-section" style="padding: 0.9rem 0;" id="ubicacion">
            <div class="text-center">
                <h2 class="section-heading text-uppercase" style="margin-bottom:1px;"><img src="static/assets/img/mapa.png" width="360" height="80"></h2>
            </div>
            <div class="container" id="mapid" style="height: 420px">
                <div class="col-sm-12">            
                </div>
            </div>
        </section>
        <!-- HISTORIAL-->
        <section class="page-section" id="historial">
              <div class="container">
                <div class="text-center">
                <h2 class="section-heading text-uppercase" style="color:white;padding:0px; margin-bottom:0px;"><img src="static/assets/img/historial1.png" width="570" height="80"></h2>
                <audio id=audio style="display: none" controls>
                    <source type="audio/mp3" src="static/audios/alerta1.mp3">
                </audio>
                </div>
                <div class="row">
                    <div class="col-sm-12">
                        <div>
                            <table id="history_table" class="table table-bordered table-hover table-striped table-sm text-center">
                                <thead>
                                    <tr>
                                        <th scope="col">Id</th>
                                        <th scope="col">Imagen color</th>
                                        <th scope="col">Imagen térmica</th>
                                        <th scope="col">Latitud</th>
                                        <th scope="col">Longitud</th>
                                        <th scope="col">Fecha y Hora</th>
                                    </tr>
                                </thead>
                                <tbody style="vertical-align: middle;">
                                </tbody>
                            </table>			
                        </div>			
                    </div>
                </div>    
              </div>
        </section>
        
        <script src="static/js/jquery-3.6.0.min.js"></script>
        <script src="static/js/jquery.dataTables.js"></script>
        <script src="static/js/dataTables.bootstrap4.js"></script>
        
        <script src="static/js/jquery.jgrowl.min.js"></script>
        
        <!-- SCRIPT PARA AGREGAR FILAS DE TABLA -->
        <script>
          
          var lat = "";
          var lng = "";
          var map = null;
          var mymarker = null; 
          
          var aux_var=0
          
          ///////////////////GENERAR FECHA ACTUAL////////////////
          f_hoy = new Date();
          console.log(f_hoy);
          
          if(f_hoy.getDate()<10){
            hoy='0' + f_hoy.getDate();
          }
          else{
            hoy=f_hoy.getDate();
          }
          if((f_hoy.getMonth() + 1)<10){
            mesActual='0' + (f_hoy.getMonth() + 1);
          }
          else{
            mesActual=(f_hoy.getMonth() + 1);
          }
          fecha_actual=hoy + '-' + mesActual + '-' + f_hoy.getFullYear();
          console.log(fecha_actual)
          ///////////////////////////////////////////////////////
          
          
          /*APENAS SE EJECUTA EL SCRIPT SE MOSTRARA UN MAPA INICIAL CON LAS UBICACIONES DE LAS ALERTAS DEL DIA ACTUAL
           Y LLENARA EL HISTORIAL CON TODA LA INFORMACIóN QUE SE ENCUENTRE EN LA BASE DE DATOS*/
          
          $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};

          $.getJSON($SCRIPT_ROOT + '/alerta',
          function (data) {
            $('#resultado').text(data.resultado);
            $('#latitud').text(data.latitud);
            $('#longitud').text(data.longitud);
            $('#espacio_libre').text(data.espacio_libre);
            
            if (data.espacio_libre > 75){
              $.jGrowl("Queda poco espacio en el servidor, se recomienda eliminar algunas imagenes",{ life : 5000});
            }
            if (data.longitud!==' '){
                lat=data.latitud;
                lng=data.longitud;
            }
            else{
              console.log(lat)
              lat=lat;
              lng=lng;
            }
              
            if (map === null){
                map = L.map('mapid').setView([lat, lng], 23);
            }
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map)	
            
            // CREAR PROPIO ICONO PARA COLOCARLO EN EL MAPA DE LEAFLET
            Icono = L.icon({
            iconUrl: "static/assets/img/incendio-forestal_icono.png",
            iconSize: [40, 50],
            iconAnchor: [25, 50],
            shadowUrl: "static/assets/img/marker-shadow.png",
            shadowSize: [40, 65],
            shadowAnchor: [15, 65],
            popupAnchor: [0, -40]
            }); 
            
            console.log("inicio");
            
            //COMPRUEBA INFORMACIÓN EN LA BASE DE DATOS PARA MOSTRARLA EN EL HISTORIAL
            for (i of data.resultado){
                
              if (i[0]!== ' '){
                var save_table='<tr>'+
                    '<td>' + i[0] + '</td>'+
                    '<td style="vertical-align: center;" ><a id="colorcam" href=' + i[1] + ' data-lightbox="image-1"><img id="colorcam" src=' + i[1] + ' width="100" height="80"></a></td>'+
                    '<td style="vertical-align: center;"><a id="tercam" href=' + i[2] + ' data-lightbox="image-2"><img src=' + i[2] + ' width="100" height="80"></a></td>'+
                    '<td style="vertical-align: center;">' + i[3] + '</td>'+ 
                    '<td style="vertical-align: center;">' + i[4] + '</td>'+
                    '<td style="vertical-align: center;">' + i[5] + '</td>'+ 
                  '</tr>'
                var actual_bd=i[5].substr(0, 10);  
                 
                // IMPRIME EN EL MAPA TODAS LAS UBICACIONES DEL DÍA ACTUAL
                if (actual_bd===fecha_actual){
                 mymarker= L.marker([i[3],i[4]], {icon: Icono}).addTo(map)
                .bindPopup('Lat=' + i[3] + ' Long=' + i[4])
                .openPopup();
                } 
                $('#history_table tbody').prepend(save_table);		
              }
            }
          console.log("FIN FOR")
          aux_var=10
          console.log("valor ", aux_var)
            
          tabla_p=$('#history_table').DataTable({
          "order": [[0, "desc"]],	
          "pagingType": "simple_numbers", 
          "scrollY": "320px",
          "scrollCollapse": true,
          "columnDefs":[{
                  "targets": '_all',
                  "sortable": false
              },
              {
                  "targets": [ 0 ],
                  "visible": false,
                  "searchable": false
              }
              
              ],
              
          "language": {
            "decimal": "",
            "emptyTable": "No hay información",
            "info": "Mostrando _START_ a _END_ de _TOTAL_ Entradas",
            "infoEmpty": "Mostrando 0 to 0 of 0 Entradas",
            "infoFiltered": "(Filtrado de _MAX_ total entradas)",
            "infoPostFix": "",
            "thousands": ",",
            "lengthMenu": "Mostrar _MENU_ Entradas",
            "loadingRecords": "Cargando...",
            "processing": "Procesando...",
            "search": "Buscar:",
            "zeroRecords": "Sin resultados encontrados",
            "paginate": {
              "first": "Primero",
              "last": "Ultimo",
              "next": "Siguiente",
              "previous": "Anterior"
            }
                    
          },

          });
                 
          });
   
        </script>
          
        <script>
          
          var intervalID = setInterval(update_values2,10000);
          $SCRIPT_ROOT = {{request.script_root|tojson|safe}};
          function update_values2() {
             
            $.getJSON($SCRIPT_ROOT + '/alerta',
            function (data) {
            $('#mensaje').text(data.mensaje);
            $('#ruta_color').text(data.ruta_color);
            $('#ruta_termica').text(data.termica);
            $('#date').text(data.date);
            $('#latitud').text(data.latitud);
            $('#longitud').text(data.longitud);
            $('#contador').text(data.contador);
            
            if (data.longitud!==' '){
              lat=data.latitud;
              lng=data.longitud;
            }
            else{
              console.log(lat)
              lat=lat;
              lng=lng;
            }
            mensaje = data.mensaje
            console.log("RUTAS_IMAGENES")
            console.log(data.ruta_color)
            console.log(data.ruta_termica) 
              
            
            var datos=[
            data.contador,
            '<a id="colorcam" href='+ data.ruta_color + ' data-lightbox="image-1"><img src='+ data.ruta_color + ' width="100" height="80"></a></td>',
            '<a id="tercam" href='+ data.ruta_termica + ' data-lightbox="image-2"><img src='+ data.ruta_termica + ' width="100" height="80"></a></td>',
            data.latitud,
            data.longitud,
            data.date]
            var audio = document.getElementById("audio"); 
            
            if (mensaje === "incendio"){
              audio.play();
              $.jGrowl(" ¡ALERTA!\nSe ha detectado un posible incendio forestal",{ life : 5000});
              tabla_p.row.add(datos).draw(false);
              tabla_p.order([0, 'desc']).draw();
              
              console.log('map2' + map) 
              console.log(lat + ' ' + lng);
              if (map === null){
                console.log('map2 dentro')
                map = L.map('mapid').setView([lat, lng], 23);
              }
              
              L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
              }).addTo(map)	
              
              mymarker= L.marker([lat,lng],  {icon: Icono
              }).addTo(map)
              .bindPopup('Lat=' + lat + ' Lng=' + lng)
              .openPopup();   
            
            }
            
            console.log(mensaje);
            console.log(data.date);
            console.log(data.ruta_color);                      
            });
            
          }
          
        </script>

        <script src="static/js/leaflet.js"
            integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
            crossorigin=""></script>


        <!-- Bootstrap core JS-->
        
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Third party plugin JS-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.4.1/jquery.easing.min.js"></script>

        <!-- Core theme JS-->
        <script src="static/js/scripts.js"></script>
        <script src="static/js/bootstrap.min.js"></script>
        <script src="static/js/lightbox.js"></scrip<script src="static/js/table.js"></script>t>
    </body>
</html>
